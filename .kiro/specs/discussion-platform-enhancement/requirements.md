# 要件定義書

## はじめに

既存のOwlNestアプリケーションを基盤として、本格的な議論プラットフォームサービスに発展させます。現在のPros/Cons形式の議論表示機能を拡張し、ユーザー認証、議論の作成・管理、リアルタイム更新、検索機能などを追加して、包括的な議論プラットフォームを構築します。

## 要件

### 要件1: ユーザー認証・管理システム

**ユーザーストーリー:** ユーザーとして、アカウントを作成してログインし、自分の議論や投稿を管理したい

#### 受け入れ基準

1. WHEN ユーザーが新規登録フォームに必要情報を入力 THEN システムは新しいアカウントを作成する
2. WHEN ユーザーが有効な認証情報でログイン THEN システムはユーザーセッションを開始する
3. WHEN ユーザーがログアウト THEN システムはセッションを終了し、ログイン画面にリダイレクトする
4. WHEN 認証されていないユーザーが保護されたページにアクセス THEN システムはログインページにリダイレクトする

### 要件1.1: ユーザー権限システム

**ユーザーストーリー:** システム管理者として、ユーザーに適切な権限を付与し、プラットフォームの安全な運用を行いたい

#### 受け入れ基準

1. WHEN 新規ユーザーが登録 THEN システムはデフォルトで閲覧可能ユーザ権限を付与する
2. WHEN 閲覧可能ユーザーが議論ページにアクセス THEN システムは議論の閲覧を許可し、投稿フォームを非表示にする
3. WHEN 投稿可能ユーザーが議論ページにアクセス THEN システムは閲覧と投稿フォームの表示を許可する
4. WHEN 投稿可能ユーザーが議論作成ページにアクセス THEN システムはアクセスを拒否し、権限不足メッセージを表示する
5. WHEN 議論作成可能ユーザーが議論作成ページにアクセス THEN システムは議論作成フォームを表示する
6. WHEN 議論作成可能ユーザーが他者の議論編集を試行 THEN システムはアクセスを拒否し、所有者のみ編集可能メッセージを表示する
7. WHEN システム管理者ユーザーが任意の機能にアクセス THEN システムは全ての機能へのアクセスを許可する
8. WHEN システム管理者がユーザー権限を変更 THEN システムは権限変更を適用し、対象ユーザーに通知する

### 要件1.2: 権限別機能制御

**ユーザーストーリー:** 各権限レベルのユーザーとして、自分の権限に応じた機能を利用したい

#### 受け入れ基準

1. WHEN 閲覧可能ユーザーがシステムにログイン THEN システムは議論一覧と議論詳細の閲覧機能のみを提供する
2. WHEN 投稿可能ユーザーがシステムにログイン THEN システムは閲覧機能に加えて投稿作成・編集・削除機能を提供する
3. WHEN 議論作成可能ユーザーがシステムにログイン THEN システムは投稿機能に加えて議論作成・編集・削除機能を提供する
4. WHEN 議論作成可能ユーザーが自身の議論を管理 THEN システムは完全な編集・削除権限を提供する
5. WHEN 議論作成可能ユーザーが他者の議論にアクセス THEN システムは投稿機能のみを提供する
6. WHEN システム管理者がユーザー管理画面にアクセス THEN システムは全ユーザーの権限変更・削除・利用停止機能を提供する
7. WHEN システム管理者が議論管理画面にアクセス THEN システムは全議論の編集・削除・モデレーション機能を提供する
8. WHEN 権限不足のユーザーが制限された機能にアクセス THEN システムは適切なエラーメッセージと権限昇格の案内を表示する

### 要件1.3: システム管理者による議論所有者変更

**ユーザーストーリー:** システム管理者として、必要に応じて議論の所有者を変更し、適切な議論管理を維持したい

#### 受け入れ基準

1. WHEN システム管理者が議論管理画面で所有者変更機能にアクセス THEN システムは現在の所有者情報と変更フォームを表示する
2. WHEN システム管理者が新しい所有者を選択 THEN システムは議論作成可能ユーザー以上の権限を持つユーザーリストを提供する
3. WHEN システム管理者が所有者変更を実行 THEN システムは議論の所有者を変更し、新旧所有者に通知を送信する
4. WHEN 所有者が変更された場合 THEN システムは新しい所有者に議論の完全な管理権限を付与する
5. WHEN 所有者が変更された場合 THEN システムは前の所有者の管理権限を取り消し、投稿権限のみを残す

### 要件1.4: 議論所有者による投稿管理

**ユーザーストーリー:** 議論作成可能ユーザーとして、自身が所有する議論の投稿を適切に管理し、健全な議論環境を維持したい

#### 受け入れ基準

1. WHEN 議論作成可能ユーザーが自身の議論の投稿を表示 THEN システムは各投稿に削除・非表示オプションを提供する
2. WHEN 議論所有者が他者の投稿を削除 THEN システムは投稿を完全に削除し、投稿者に通知を送信する
3. WHEN 議論所有者が他者の投稿を非表示に設定 THEN システムは投稿を非表示にし、所有者のみが閲覧可能にする
4. WHEN 議論所有者が非表示投稿を再表示 THEN システムは投稿を再び全ユーザーに表示する
5. WHEN 議論所有者が投稿管理を実行 THEN システムは操作ログを記録し、必要に応じて復元可能にする

### 要件2: 議論の作成・管理機能

**ユーザーストーリー:** 認証されたユーザーとして、新しい議論トピックを作成し、既存の議論を管理したい

#### 受け入れ基準

1. WHEN 認証されたユーザーが議論作成フォームを送信 THEN システムは新しい議論を作成し、作成者を議論の所有者に設定する
2. WHEN 議論の所有者が議論設定を変更 THEN システムは変更を保存し、他のユーザーに反映する
3. WHEN ユーザーが議論一覧を表示 THEN システムは利用可能な議論をカテゴリ別に表示する
4. WHEN 議論の所有者が議論を削除 THEN システムは議論と関連する全ての投稿を削除する

### 要件2.1: 議論作成フォームの必須項目

**ユーザーストーリー:** 議論作成者として、構造化された議論を作成するために必要な情報を入力したい

#### 受け入れ基準

1. WHEN ユーザーが議論作成フォームにアクセス THEN システムは議題の入力欄を必須項目として表示する
2. WHEN ユーザーが議題の概要を入力 THEN システムは概要を必須項目として検証する
3. WHEN ユーザーが議論の所有者のスタンスを選択 THEN システムはPros/Cons/中立/わからない/非表示の選択肢を提供する
4. WHEN ユーザーが議論の論点を入力 THEN システムは1つ以上の論点入力を必須として検証する
5. WHEN ユーザーが複数の論点を追加 THEN システムは動的に論点入力欄を追加する
6. WHEN ユーザーが階層構造の論点を作成 THEN システムは親子関係を持つ論点の入力を可能にする
7. WHEN ユーザーが議論カテゴリを選択 THEN システムは1つ以上のカテゴリ選択を必須として検証する
8. WHEN ユーザーが複数のカテゴリを選択 THEN システムは複数選択を可能にする
9. WHEN 必須項目が未入力の状態で送信 THEN システムはエラーメッセージを表示し、送信を阻止する

### 要件2.1.1: 議論カテゴリシステム

**ユーザーストーリー:** 議論作成者として、議論を適切なカテゴリに分類し、他のユーザーが見つけやすくしたい

#### 受け入れ基準

1. WHEN ユーザーが議論カテゴリ選択欄にアクセス THEN システムは以下の階層構造カテゴリを表示する：
   - 政治（国の政治、地方政治、国際政治、選挙、政治家・政党、憲法・法制度）
   - 経済・産業（経済、金融・投資、雇用・労働、地方経済、産業全般、交通・物流、中小企業・スタートアップ）
   - 社会・生活（社会問題全般、教育、医療・福祉、防災・災害対応、生活習慣・健康、恋愛・結婚、家族・子育て）
   - ネット・テクノロジー（ネット文化、SNS・炎上、ゲーム・eスポーツ、AI・機械学習、セキュリティ・個人情報、ガジェット・スマホ、先端技術）
   - エンタメ（芸能ニュース、音楽・ライブ、映画・ドラマ、お笑い・芸人、漫画・アニメ、声優・二次元文化、サブカル・同人）
   - スポーツ（野球、サッカー、バスケットボール、格闘技、オリンピック・国際大会、スポーツ選手・チーム、スポーツ観戦文化）
   - その他
2. WHEN ユーザーが大カテゴリを選択 THEN システムは該当する小カテゴリの選択肢を表示する
3. WHEN ユーザーが小カテゴリを選択 THEN システムは選択されたカテゴリを議論に関連付ける
4. WHEN ユーザーが複数の大カテゴリから小カテゴリを選択 THEN システムは異なる大カテゴリからの複数選択を可能にする
5. WHEN カテゴリが選択されていない状態で送信 THEN システムはカテゴリ選択を促すエラーメッセージを表示する

### 要件2.2: 議論作成フォームの任意項目

**ユーザーストーリー:** 議論作成者として、議論の理解を深めるための前提知識を提供したい

#### 受け入れ基準

1. WHEN ユーザーが前提知識セクションにアクセス THEN システムはテキスト入力欄を提供する
2. WHEN ユーザーがファイルをアップロード THEN システムは適切なファイル形式を検証し、保存する
3. WHEN ユーザーがURLを入力 THEN システムはURL形式を検証し、リンクとして保存する
4. WHEN ユーザーが前提知識を複数追加 THEN システムは複数の前提知識項目を管理する
5. WHEN 任意項目が未入力でも THEN システムは議論作成を正常に完了する

### 要件2.3: 議論アクセス制御

**ユーザーストーリー:** 議論の所有者として、議論に投稿できるユーザーを制限し、健全な議論環境を維持したい

#### 受け入れ基準

1. WHEN 議論の所有者がアクセス制御設定にアクセス THEN システムはブラックリスト方式とホワイトリスト方式の選択肢を提供する
2. WHEN 所有者がブラックリスト方式を選択 THEN システムは指定されたユーザーの投稿を禁止し、他の全ユーザーの投稿を許可する
3. WHEN 所有者がホワイトリスト方式を選択 THEN システムは指定されたユーザーのみの投稿を許可し、他のユーザーの投稿を禁止する
4. WHEN 制限されたユーザーが投稿を試行 THEN システムは投稿を拒否し、アクセス制限メッセージを表示する
5. WHEN 所有者がアクセス制御リストを更新 THEN システムは即座に新しい制限を適用する

### 要件2.4: 議論作成フォームのデフォルト値設定

**ユーザーストーリー:** ユーザーとして、議論作成時に適切なデフォルト値が設定されていることで、効率的に議論を作成したい

#### 受け入れ基準

1. WHEN ユーザーが議論作成フォームのスタンス項目にアクセス THEN システムはデフォルト値として「わからない」を設定する
2. WHEN 同じユーザーが過去に同じ議論に投稿している場合 THEN システムは最後の投稿時のスタンスをデフォルト値として設定する
3. WHEN ユーザーがスタンスを変更せずにフォームを送信 THEN システムはデフォルト値を使用して議論を作成する

### 要件3: 投稿・コメント機能の拡張

**ユーザーストーリー:** 議論参加者として、Pros/Consの投稿を作成し、他の投稿にコメントや反応をしたい

#### 受け入れ基準

1. WHEN 認証されたユーザーが投稿フォームを送信 THEN システムは投稿を議論に追加し、リアルタイムで他のユーザーに表示する
2. WHEN ユーザーが投稿に画像やリンクを添付 THEN システムは添付ファイルを適切に表示する
3. WHEN ユーザーが他の投稿にコメント THEN システムはコメントを投稿に関連付けて表示する
4. WHEN ユーザーが投稿に「いいね」や「同意」の反応 THEN システムは反応数を更新し、表示する
5. WHEN 投稿の作成者が自分の投稿を編集または削除 THEN システムは変更を適用し、他のユーザーに反映する

### 要件3.1: 投稿フォームの必須項目

**ユーザーストーリー:** 議論参加者として、構造化された投稿を作成するために必要な情報を入力したい

#### 受け入れ基準

1. WHEN ユーザーが投稿フォームにアクセス THEN システムは登録対象となる論点の選択欄を必須項目として表示する
2. WHEN ユーザーが論点を選択 THEN システムは議論で定義された論点リストから選択可能にする
3. WHEN ユーザーが意見を入力 THEN システムはリッチテキストエディタを提供し、太字設定を可能にする
4. WHEN ユーザーが文字サイズを選択 THEN システムは大・中・小の文字サイズ選択肢を提供する
5. WHEN ユーザーが意見に画像を埋め込み THEN システムは画像アップロード機能を提供する
6. WHEN ユーザーが意見にリンクを埋め込み THEN システムはURL入力とリンク挿入機能を提供する
7. WHEN ユーザーがスタンスを選択 THEN システムはPros/Cons/中立/わからない/非表示の選択肢を必須として提供する
8. WHEN 必須項目が未入力で送信 THEN システムはエラーメッセージを表示し、送信を阻止する

### 要件3.1.1: 投稿フォームのデフォルト値設定

**ユーザーストーリー:** ユーザーとして、投稿時に適切なデフォルト値が設定されていることで、効率的に投稿を作成したい

#### 受け入れ基準

1. WHEN ユーザーが投稿フォームのスタンス項目にアクセス THEN システムはデフォルト値として「わからない」を設定する
2. WHEN 同じユーザーが過去に同じ議論に投稿している場合 THEN システムは最後の投稿時のスタンスをデフォルト値として設定する
3. WHEN ユーザーがスタンスを変更せずに投稿を送信 THEN システムはデフォルト値を使用して投稿を作成する

### 要件3.2: 投稿フォームの任意項目

**ユーザーストーリー:** 議論参加者として、投稿に追加情報や関連性を付与したい

#### 受け入れ基準

1. WHEN ユーザーが追加の画像やリンクを添付 THEN システムは複数のメディア添付を可能にする
2. WHEN ユーザーが他の投稿への返信を設定 THEN システムは既存投稿の選択機能を提供する
3. WHEN 返信先が設定された場合 THEN システムは返信関係を視覚的に表示する
4. WHEN 任意項目が未入力でも THEN システムは投稿作成を正常に完了する

### 要件3.3: 階層構造による投稿表示とフィルタリング

**ユーザーストーリー:** 議論参加者として、議論の論点に応じて整理された投稿を確認し、必要に応じてフィルタリングしたい

#### 受け入れ基準

1. WHEN ユーザーが議論ページを表示 THEN システムはデフォルトで議論の論点別に投稿を整理して表示する
2. WHEN 各論点に投稿が存在 THEN システムは論点別に投稿をグループ化して表示する
3. WHEN 論点が親子関係を持つ場合 THEN システムは階層レベルに応じてインデントや視覚的区別を適用する
4. WHEN ユーザーが特定の論点を展開/折りたたみ THEN システムはその論点配下の投稿の表示/非表示を切り替える
5. WHEN ユーザーがユーザー別フィルタを選択 THEN システムは指定されたユーザーの投稿のみを表示する
6. WHEN ユーザーがスタンス別フィルタを選択 THEN システムは指定されたスタンス（Pros/Cons/中立/わからない）の投稿のみを表示する
7. WHEN ユーザーがソート条件を変更 THEN システムは投稿日時、いいね数、返信数などでソートを適用する
8. WHEN 複数のフィルタが適用された場合 THEN システムは全ての条件を満たす投稿のみを表示する

### 要件4: リアルタイム更新機能

**ユーザーストーリー:** 議論参加者として、他のユーザーの投稿やコメントをリアルタイムで確認したい

#### 受け入れ基準

1. WHEN 他のユーザーが新しい投稿を作成 THEN システムは接続中の全ユーザーに即座に投稿を表示する
2. WHEN 他のユーザーが投稿を編集または削除 THEN システムは変更を即座に反映する
3. WHEN ユーザーが議論ページを開いている間に新しいコメントが追加 THEN システムは自動的にコメントを表示する
4. WHEN 接続が一時的に切断された場合 THEN システムは再接続時に最新の状態に同期する

### 要件5: 検索・フィルタリング機能

**ユーザーストーリー:** ユーザーとして、特定のトピックや投稿を効率的に見つけたい

#### 受け入れ基準

1. WHEN ユーザーがキーワードで検索 THEN システムは関連する議論と投稿を表示する
2. WHEN ユーザーがカテゴリでフィルタリング THEN システムは該当カテゴリの議論のみを表示する
3. WHEN ユーザーがPros/Consでフィルタリング THEN システムは指定されたスタンスの投稿のみを表示する
4. WHEN ユーザーが日付範囲で検索 THEN システムは指定期間内の投稿を表示する
5. WHEN ユーザがユーザ名で検索 THEN システムは該当ユーザを表示する
6. WHEN ユーザがユーザを選択 THEN システムはそのユーザが所有している議論と登録を表示する

### 要件6: フォロー機能とタイムライン

**ユーザーストーリー:** ユーザーとして、興味のあるユーザーや議論をフォローし、最新の活動を効率的に確認したい

#### 受け入れ基準

1. WHEN ユーザーが他のユーザーのプロフィールページでフォローボタンをクリック THEN システムはフォロー関係を作成する
2. WHEN ユーザーが議論ページでフォローボタンをクリック THEN システムは議論のフォロー関係を作成する
3. WHEN ユーザーがタイムラインページにアクセス THEN システムはフォローしているユーザーと議論の最新投稿を時系列で表示する
4. WHEN フォローしているユーザーが新しい投稿を作成 THEN システムはタイムラインに投稿を追加する
5. WHEN フォローしている議論に新しい投稿が追加 THEN システムはタイムラインに投稿を追加する
6. WHEN ユーザーがフォローを解除 THEN システムはフォロー関係を削除し、タイムラインから該当コンテンツを除外する

### 要件7: 通知システム

**ユーザーストーリー:** ユーザーとして、自分に関連する活動について通知を受け取りたい

#### 受け入れ基準

1. WHEN 他のユーザーが自分の投稿にコメント THEN システムはユーザーに通知を送信する
2. WHEN フォローしている議論に新しい投稿が追加 THEN システムはフォロワーに通知を送信する
3. WHEN ユーザーがメンションされた場合 THEN システムは該当ユーザーに通知を送信する
4. WHEN ユーザーが通知設定を変更 THEN システムは新しい設定に従って通知を送信する

### 要件8: モデレーション機能

**ユーザーストーリー:** モデレーターとして、不適切なコンテンツを管理し、健全な議論環境を維持したい

#### 受け入れ基準

1. WHEN モデレーターが投稿を不適切と判断 THEN システムは投稿を非表示にし、作成者に通知する
2. WHEN ユーザーが投稿を報告 THEN システムは報告をモデレーションキューに追加する
3. WHEN モデレーターがユーザーを一時停止 THEN システムはユーザーの投稿権限を制限する
4. WHEN 自動フィルターが不適切なコンテンツを検出 THEN システムは投稿を保留し、モデレーターに通知する

### 要件9: データ分析・レポート機能

**ユーザーストーリー:** 議論の主催者として、議論の活動状況や参加者の傾向を把握したい

#### 受け入れ基準

1. WHEN 議論の主催者がダッシュボードを表示 THEN システムは参加者数、投稿数、エンゲージメント率を表示する
2. WHEN 管理者が全体統計を確認 THEN システムはプラットフォーム全体の利用状況を表示する
3. WHEN ユーザーが議論の傾向分析を要求 THEN システムはPros/Consの分布や時系列変化を表示する
4. WHEN データをエクスポート THEN システムはCSVまたはJSON形式でデータを提供する
